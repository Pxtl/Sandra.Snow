name: Publish PxtlCa

on: 
  push:
    paths:
      - 'SnowSite/**'
      - '.github/workflows/*'
  workflow_dispatch:
  workflow_run:
    workflows: ["Build Snow"]
    types:
      - completed

jobs:
  publish:
    runs-on: windows-latest
    strategy:
      fail-fast: true
    steps:
      - name: Checkout SnowSite
        uses: actions/checkout@v3
        with:
          sparse-checkout: SnowSite
          path: doc
      - name: Checkout Pxtl.github.io
        uses: actions/checkout@v3
        with:
          repository: Pxtl/Pxtl.github.io
          path: Pxtl.github.io
      - name: Download Snow artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: build-snow.yml
      - name: run Snow
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          & Snow\Snow.exe config=.\doc\SnowSite\Snow\Snow.config

          "Updating Pxtl.github.io
          $lastMessage = git log -1 --pretty=%B | Select-Object -First 1
          cd Pxtl.github.io
          git add .
          git commit -m "Publish: $lastMessage"
          git push
